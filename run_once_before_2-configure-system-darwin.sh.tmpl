#!/bin/bash
{{ if (eq .chezmoi.os "darwin") -}}

# Inspired from https://github.com/politician/dotfiles/blob/main/run_once_before_2-configure-system-darwin.sh.tmpl

# Force System prefrences to quit
osascript -e 'tell application "System Preferences" to quit'
# Source dock functions
source "./dock_operations.sh"

# ---------------------------------------------------------------------------------------------------------------------
# Global settings
# ---------------------------------------------------------------------------------------------------------------------

echo "Modifying macOS Global Settings"

# Do not autogather large files when submitting a feedback report
defaults write com.apple.appleseed.FeedbackAssistant "Autogather" -bool "false" 
# Disable automatic capitalization
defaults write -g NSAutomaticCapitalizationEnabled -bool false
# Enable smart dashes
defaults write -g NSAutomaticDashSubstitutionEnabled -bool true
# Prevent Photos from opening automatically when devices are plugged in
defaults -currentHost write com.apple.ImageCapture disableHotPlug -bool true && killall Photos
# Save/Print modals are auto-expanded by default
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
# Trackpad: enable tap to click for this user and for the login screen
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# ---------------------------------------------------------------------------------------------------------------------
# Security settings
# ---------------------------------------------------------------------------------------------------------------------
# Enable TouchID for sudo
! grep -q pam_tid.so /etc/pam.d/sudo && sudo gsed -i '2iauth        sufficient     pam_tid.so' /etc/pam.d/sudo
# Ensure Secure Keyboard Entry in Terminal is enabled
defaults write -app Terminal SecureKeyboardEntry -bool true
defaults write -app iTerm SecureKeyboardEntry -bool true

# ---------------------------------------------------------------------------------------------------------------------
# AuthorizationDB settings
# The authorizationdb settings cannot be written to directly, so the plist must be exported out to temporary file
# ---------------------------------------------------------------------------------------------------------------------
# Export AuthorizationDB settings to temporary file
sudo security authorizationdb read system.preferences > /tmp/system.preferences.plist

# Require an administrator password to access system-wide preferences
# https://www.tenable.com/audits/CIS_Apple_macOS_11_v2.0.0_L1
sudo defaults write /tmp/system.preferences.plist shared -bool false

# Import AuthorizationDB settings from temporary file
sudo security authorizationdb write system.preferences < /tmp/system.preferences.plist

# ---------------------------------------------------------------------------------------------------------------------
# Dock settings
# ---------------------------------------------------------------------------------------------------------------------
# Set dock position
defaults write com.apple.dock orientation -string "bottom"
# Set the icon size of Dock items in pixels
defaults write com.apple.dock "tilesize" -int 43
# Minimize windows into their application’s icon
defaults write com.apple.dock minimize-to-application -bool false
# Enable launch animation
defaults write com.apple.dock launchanim -bool true
# Show indicator lights for open applications in the Dock
defaults write com.apple.dock show-process-indicators -bool true
# Don’t show recent applications in Dock
defaults write com.apple.dock show-recents -bool false
# Clear Dock
clear_dock
# Declare apps to set to dock
declare -a apps=(
    '/System/Cryptexes/App/System/Applications/Safari.app'
    '/Applications/Visual Studio Code.app'
    '/Applications/Ghostty.app'
    '/System/Applications/Mail.app'
    '/System/Applications/Calendar.app'
    '/System/Applications/Music.app'
);
# Add apps to dock
for app in "${apps[@]}"; do
    add_app_to_dock "$app"
done
# Add folders to dock (not done in an array as I need to pass options to add_folder_to_dock)
add_folder_to_dock "$HOME/Downloads" --arrangement 3 --displayAs 0 --showAs 1
add_folder_to_dock "$HOME/Developer" --arrangement 1 --displayAs 1 --showAs 2
# Kill Dock
killall Dock

# ---------------------------------------------------------------------------------------------------------------------
# Finder settings
# ---------------------------------------------------------------------------------------------------------------------
# Do not show hidden files
defaults write com.apple.Finder "AppleShowAllFiles" -bool "false"
# Allowing text selection in Quick Look/Preview in Finder by default
defaults write com.apple.finder QLEnableTextSelection -bool true
# When performing a search, search the current folder by default (WHY IS THIS NOT THE DEFAULT?!)
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
# Use list view in all Finder windows by default
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
defaults write com.apple.finder SearchRecentsSavedViewStyle -string "Nlsv"
# Disable creation of metadata files on external volumes
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true
# Empty Trash securely by default
defaults write com.apple.finder EmptyTrashSecurely -bool true

killall Finder

# ---------------------------------------------------------------------------------------------------------------------
# Firewall settings
# ---------------------------------------------------------------------------------------------------------------------
# Enable firewall
sudo defaults write /Library/Preferences/com.apple.alf globalstate -int 1
sudo defaults write /Library/Preferences/com.apple.alf stealthenabled -int 1

#launchctl unload /System/Library/LaunchAgents/com.apple.alf.useragent.plist
#sudo launchctl unload /System/Library/LaunchDaemons/com.apple.alf.agent.plist
#sudo launchctl load /System/Library/LaunchDaemons/com.apple.alf.agent.plist
#launchctl load /System/Library/LaunchAgents/com.apple.alf.useragent.plist

# ---------------------------------------------------------------------------------------------------------------------
# Software Update settings
# ---------------------------------------------------------------------------------------------------------------------
# Automatically check for updates
sudo defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true
# Download updates automatically in the background
sudo defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticDownload -bool true
# Install macos updates automatically
sudo defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticallyInstallMacOSUpdates -bool true
# Install system data file updates automatically
sudo defaults write /Library/Preferences/com.apple.SoftwareUpdate ConfigDataInstall -bool true
# Install critical security updates automatically
sudo defaults write /Library/Preferences/com.apple.SoftwareUpdate CriticalUpdateInstall -bool true
# Check for software updates daily, not just once per week
sudo defaults write /Library/Preferences/com.apple.SoftwareUpdate ScheduleFrequency -int 1
# Install app updates automatically
defaults write com.apple.commerce AutoUpdate -bool true

{{ end -}}
